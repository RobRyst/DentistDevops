name: build-test-scan-push

on:
  workflow_call:
    inputs:
      service_name:
        required: true
        type: string
      context:
        required: true
        type: string
      dockerfile:
        required: true
        type: string
      image_name:
        required: true
        type: string
      run_unit_tests:
        required: false
        type: boolean
        default: true
      run_integration_smoke:
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  packages: write
  security-events: write

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        if: ${{ inputs.service_name == 'backend' }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore/Build/Test (backend)
        if: ${{ inputs.service_name == 'backend' && inputs.run_unit_tests }}
        working-directory: backend
        run: |
          dotnet restore
          dotnet build -c Release --no-restore
          dotnet test -c Release --no-build

      - name: Vulnerable packages (backend)
        if: ${{ inputs.service_name == 'backend' }}
        working-directory: backend
        run: |
          dotnet list package --vulnerable --include-transitive || true

      - name: Setup Node
        if: ${{ inputs.service_name == 'frontend' }}
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install/Lint/Build (frontend)
        if: ${{ inputs.service_name == 'frontend' }}
        working-directory: frontend
        run: |
          npm ci
          npm run lint
          npm run build

      - name: npm audit (frontend)
        if: ${{ inputs.service_name == 'frontend' }}
        working-directory: frontend
        run: |
          npm audit --audit-level=high || true

      - name: Trivy FS scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          ignore-unfixed: true
          format: sarif
          output: trivy-fs.sarif
          severity: CRITICAL,HIGH

      - name: Upload Trivy FS to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-fs.sarif

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/${{ inputs.image_name }}
          tags: |
            type=sha
            type=ref,event=branch
            type=ref,event=pr

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.dockerfile }}
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Trivy image scan (SARIF)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ghcr.io/${{ github.repository_owner }}/${{ inputs.image_name }}:sha-${{ github.sha }}
          format: sarif
          output: trivy-image.sarif
          severity: CRITICAL,HIGH
          ignore-unfixed: true

      - name: Upload Trivy image to GitHub Security
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-image.sarif

      - name: Smoke test container
        if: ${{ inputs.run_integration_smoke }}
        run: |
          docker run -d --rm -p 18080:8080 --name smoke \
            ghcr.io/${{ github.repository_owner }}/${{ inputs.image_name }}:sha-${{ github.sha }}
          sleep 5
          curl -fsS http://localhost:18080/swagger/index.html >/dev/null || (docker logs smoke && exit 1)
          docker stop smoke
